name = "events-api-tampa-dev"
main = "src/index.ts"
send_metrics = true

compatibility_date = "2024-09-23"
compatibility_flags = [ "nodejs_compat", "global_fetch_strictly_public" ]

kv_namespaces = [
  { binding = "kv", id = "791983cf109c43eaa21ff4f3406de811" },
  { binding = "OAUTH_KV", id = "791983cf109c43eaa21ff4f3406de811" }
]

[[d1_databases]]
binding = "DB"
database_name = "events-db"
database_id = "bea48eca-291f-4901-83d4-4413524506a3"
migrations_dir = "drizzle/migrations"

# R2 bucket for user uploads (avatars, app logos, media)
[[r2_buckets]]
binding = "UPLOADS_BUCKET"
bucket_name = "tampa-dev-uploads-public"

[version_metadata]
binding = "CF_VERSION_METADATA"

# Cron triggers for event aggregation
# Runs every 30 minutes to fetch fresh data from external sources
[triggers]
crons = ["0,30 * * * *"]

[env.pr]
name = "events-api-pr"

[env.production]
name = "events-api-tampa-dev"

# Routes for tampa.dev paths
[[env.production.routes]]
pattern = "tampa.dev/ical*"
zone_name = "tampa.dev"

[[env.production.routes]]
pattern = "tampa.dev/webcal*"
zone_name = "tampa.dev"

[[env.production.routes]]
pattern = "tampa.dev/upcoming-events*"
zone_name = "tampa.dev"

[[env.production.routes]]
pattern = "tampa.dev/feed*"
zone_name = "tampa.dev"

[[env.production.routes]]
pattern = "tampa.dev/events.json*"
zone_name = "tampa.dev"

[[env.production.routes]]
pattern = "events.api.tampa.dev/*"
zone_name = "tampa.dev"

[[env.production.routes]]
pattern = "events.api.tampa.dev"
zone_name = "tampa.dev"
custom_domain = true

# Environment variables
[env.production.vars]
ADMIN_ALLOWLIST = "chtzvt"
GITHUB_REDIRECT_URI = "https://events.api.tampa.dev/auth/github/callback"
UPLOADS_PUBLIC_BUCKET_NAME = "tampa-dev-uploads-public"
UPLOADS_PUBLIC_URL = "https://td-uploads-public.tampa.dev"

[[env.production.kv_namespaces]]
binding = "kv"
id = "791983cf109c43eaa21ff4f3406de811"

[[env.production.kv_namespaces]]
binding = "OAUTH_KV"
id = "791983cf109c43eaa21ff4f3406de811"

[[env.production.d1_databases]]
binding = "DB"
database_name = "events-db"
database_id = "bea48eca-291f-4901-83d4-4413524506a3"
migrations_dir = "drizzle/migrations"

[[env.production.r2_buckets]]
binding = "UPLOADS_BUCKET"
bucket_name = "tampa-dev-uploads-public"

[env.production.version_metadata]
binding = "CF_VERSION_METADATA"

[env.production.triggers]
crons = ["0,30 * * * *"]
